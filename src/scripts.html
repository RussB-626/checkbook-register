<!-- jQuery library -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- Datatables -->
<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.3/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.2.3/js/responsive.bootstrap4.min.js"></script>

<!-- Popper JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
<!-- Latest compiled Bootstrap JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>

<script>

  // Class Structures

  class Transaction {
    constructor(date,account,category,description,note,amount,type,pending) {
      this.date = date;
      this.account = account;
      this.category = category;
      this.description = description;
      this.note = note;
      this.amount = financial(amount);
      this.type = type;
      this.pending = pending;
    }
  }

  class Account {
    constructor(name,groupings) {
      this.name = name;
      this.groupings = groupings ? groupings.split(',').map(e => e.trim()) : [];
    }
  }

  class Generic {
    constructor(name) {
      this.name = name;
    }
  }

  class PageData{
    constructor(txns,accounts,groups,commonTxns,expenses,incomes,transfers,catsToIgn) {
      this.txns = txns;
      this.accounts = accounts;
      this.groups = groups;
      this.commonTxns = commonTxns;
      this.expenses = expenses;
      this.incomes = incomes;
      this.transfers = transfers;
      this.catsToIgn = catsToIgn;
    }
  }

  // ==========================================================================================

  // Local Page Objects
  let pageInfo = {};

  function compilePageInfo(data) {
    //update data
    pageInfo = JSON.parse(data);

    // Calculate Lists
    calcListOfYearsToThisYear();
    calcMonthsMap();
    
    // Update Selections
    updateCommonYearsSelection();
    updateCategoriesYearsSelection();
    buildTransactionFields();

    // Finally - Build Page
    buildPage();

    // Remove Overlays
    $('#overlay').hide();
  }

  function buildPage() {
    // Reset Transaction Creation Fields
    resetInputFields();

    // Do account balances
    updateGroupingBalances();
    showTxns();
    showPending();

    // Update Common Transactions
    updateCommonInfo();

    // Update Categories Transactions
    buildCategories();

    // Update DataLists
    updateDataLists();
  }

  // ==========================================================================================

  function updateDataLists() {
    let descriptions = [];
    for(let desc of pageInfo.txns.map(t => t.description)) {
      if(!descriptions.find(d => d.name === desc)) {
        descriptions.push({name : desc});
      }
    }

    buildSelections(descriptions,'description-datalist',false,'name','name');
  }

  // ==========================================================================================

  function modalOpen(id) {
    $(id).modal({backdrop: 'static', keyboard: false});
  }
    
  function modalClose(id) {
    $(id).modal('hide');
  }

  // ==========================================================================================

  // Build selection fields
  function buildSelections(items,id,sort = false,html = 'value',value = 'value',addBlank = false,multiOrSingleOpt = "") {
    let sel = document.getElementById(id);
    sel.innerHTML = "";
    let fragment = document.createDocumentFragment();
    
    // sort values by Reference
    if(sort) items = sortArray(items,html);
    
    // If addBlank is set, add blank option
    if(addBlank) {
      let opt = document.createElement('option');
      opt.innerHTML = "";
      opt.value = "";
      fragment.appendChild(opt);
    }
    
    // Add items to selections
    for(let item of items) {
      let opt = document.createElement('option');
      opt.innerHTML = item[html];
      opt.value = item[value];
      fragment.appendChild(opt);
    }
    
    sel.appendChild(fragment);
    
    if(multiOrSingleOpt === "multi") multiSelectOptions('#' + id);
    else if(multiOrSingleOpt === "single") singleSelectOptions('#' + id);
  }

  // ==========================================================================================

  // Set Option Selection
  function setOptionSelection(option,selections) {
    if(Array.isArray(selections)) {
      // if an option value is found in the selections, set it true, else false
      option.selected = selections.some(s => s.toString() === option.value.toString());
    } else {
      option.selected = selections.toString() === option.value.toString();
    }
  }

  // ==========================================================================================

  function calcListOfYearsToThisYear() {
    let startYear = new Date().getFullYear() + 1;
    let endYear = 2024;
    let years = [];

    for(let year = startYear; year >= endYear; year--) {
      years.push({year : year});
    }
    pageInfo.years = years;
  }

  function calcMonthsMap()
  {
    pageInfo.monthsMap = {
      "JAN" : {month : "01", long : "January", short: "Jan"},
      "01" : {month : "JAN", long : "January", short: "Jan"},
      "FEB" : {month : "02", long : "February", short: "Feb"},
      "02" : {month : "FEB", long : "February", short: "Feb"},
      "MAR" : {month : "03", long : "March", short: "March"},
      "03" : {month : "MAR", long : "March", short: "March"},
      "APR" : {month : "04", long : "April", short: "April"},
      "04" : {month : "APR", long : "April", short: "April"},
      "MAY" : {month : "05", long : "May", short: "May"},
      "05" : {month : "MAY", long : "May", short: "May"},
      "JUN" : {month : "06", long : "June", short: "June"},
      "06" : {month : "JUN", long : "June", short: "June"},
      "JUL" : {month : "07", long : "July", short: "July"},
      "07" : {month : "JUL", long : "July", short: "July"},
      "AUG" : {month : "08", long : "August", short: "Aug"},
      "08" : {month : "AUG", long : "August", short: "Aug"},
      "SEP" : {month : "09", long : "September", short: "Sept"},
      "09" : {month : "SEP", long : "September", short: "Sept"},
      "OCT" : {month : "10", long : "October", short: "Oct"},
      "10" : {month : "OCT", long : "October", short: "Oct"},
      "NOV" : {month : "11", long : "November", short: "Nov"},
      "11" : {month : "NOV", long : "November", short: "Nov"},
      "DEC" : {month : "12", long : "December", short: "Dec"},
      "12" : {month : "DEC", long : "December", short: "Dec"}
    };
  }

  function monthsList () {
    return [
      "JAN",
      "FEB",
      "MAR",
      "APR",
      "MAY",
      "JUN",
      "JUL",
      "AUG",
      "SEP",
      "OCT",
      "NOV",
      "DEC"
    ];
  }

  function getDate(date) {
    if(!date) return;

    let thisYear = new Date().getFullYear();

    let year = date.substring(0,4);
    let month = date.substring(5,7);
    let day = date.substring(8,10);

    // Remove year if txn is within the same year as todays year
    if(year.toString() === thisYear.toString()) return pageInfo.monthsMap[month].short +  " " + day;
    return pageInfo.monthsMap[month].short +  " " + day + ", " + year;
  }

  function getToday()
  {
    let today = new Date();
    let dd = today.getDate();
    let mm = today.getMonth()+1;
    let yyyy = today.getFullYear();
    return yyyy + '-' + pad(mm,2) + '-' + pad(dd,2);
  }

  // ==========================================================================================

  // Sort Array Of Items
  function sortArray(arr,ref) {
    for(let i = 0; i < arr.length; i++) {
      for(let j = 0; j < (arr.length - i - 1); j++) {
        
        // Sort by ref if defined
        if(ref) {
          if(arr[j][ref] > arr[j+1][ref]){
            let lesser = arr[j+1];
            arr[j+1] = arr[j];
            arr[j] = lesser;
          }
          // Else, Sort array by base value
        } else {
          if(arr[j] > arr[j+1]) {
            let lesser = arr[j+1];
            arr[j+1] = arr[j];
            arr[j] = lesser;
          }
        }
      }
    }
    return arr;
  }

 // ==========================================================================================

  function checkField(id,class_type,error)
  {
    if(document.getElementById(id).value == "") {
      document.getElementById(id).className = class_type + " is-invalid";
      return true;
    } else {
      document.getElementById(id).className = class_type;
      if(error) return error;
      return false;
    }
  }

  // ==========================================================================================

  function financial(amount) {
    return Number.parseFloat(amount).toFixed(2);
  }

  // ==========================================================================================

  function pad(number, length) {    
    let str = '' + number;
    while (str.length < length) {
        str = '0' + str;
    }    
    return str;
  }

</script>